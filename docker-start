#!/bin/bash
USAGE=\
"Usage: ./docker-start [ test | e2e | watche2e | shell | dev | prod | down ] [ up | build ]?\n\n"\
"\ttest: run jest test watcher on backend unit tests\n"\
"\te2e: run jest/supertest end to end test on application\n"\
"\twatche2e: run jest/supertest end to end test in watch mode -- dont use\n"\
"\tshell: opens a shell on the backend container\n"\
"\tdev: spin up backend in development mode\n"\
"\tprod: spin up backend in production mode\n"\
"\tdown: spin down all running containers and network\n"\
"\n\tGo Cibic!\n"

DC_DIR=scripts/docker-compose
DEFAULT='up -d'
CMD=${2:-$DEFAULT}

if [ -z $1 ]
then
    echo -e $USAGE;
elif [ $1 = "test" -o $1 = "e2e" -o $1 = "watche2e" -o $1 = "shell" ]
then
    if [ $USER = "ubuntu" ]
    then
        echo "DO NOT RUN THIS ON EC2 IT WILL DESTROY THE DATABASE"
        exit;
    fi
    docker-compose down;
    docker-compose -f docker-compose.yml -f $DC_DIR/docker-compose.$1.yml $CMD;
    if [ $? = '0' -a "${CMD}" = "${DEFAULT}" ]
    then
        docker attach $(docker ps -q | head -n1);
        docker volume prune -f;
    fi
elif [ $1 = "dev" -o $1 = "prod" ]
then
    docker-compose down;
    docker-compose -f docker-compose.yml -f $DC_DIR/docker-compose.$1.yml $CMD;
elif [ $1 = "down" ]
then
    docker-compose down;
fi
